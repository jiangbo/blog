# 1013-地宫探险-移动消息

## 目标

将直接控制角色和怪兽移动修改成移动消息。

## 环境

- Time 2025-10-28
- Zig 0.15.2

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

书本上说的不直接移动而是发送一个移动的消息，然后真正的移动放到地图去检查。

## map.zig

地图模块新增了一个真正移动的方法。

```zig
pub fn update(_: f32) void {
    moveIfNeed();
}

fn moveIfNeed() void {
    var view = ecs.w.view(.{ WantsToMove, Vec });
    while (view.next()) |entity| {
        const dest = view.get(entity, WantsToMove).dest;
        const canMove = dest.x < WIDTH and dest.y < HEIGHT //
        and indexTile(dest.x, dest.y) == .floor;
        if (!canMove) continue;

        view.getPtr(entity, Vec).* = dest;
        const pos = worldPosition(dest);
        view.getPtr(entity, gfx.Vector).* = pos;
    }
}
```

## player.zig

角色中直接控制移动的代码删除了。

```zig
const std = @import("std");
const zhu = @import("zhu");

const gfx = zhu.gfx;
const window = zhu.window;
const camera = zhu.camera;
const ecs = zhu.ecs;

const map = @import("map.zig");
const battle = @import("battle.zig");

pub var entity: ecs.Entity = undefined;

pub fn init() void {
    entity = ecs.w.createEntity();
    const tilePos = map.center(map.rooms[0]);
    ecs.w.add(entity, tilePos);
    ecs.w.add(entity, map.getTextureFromTile(.player));
    ecs.w.add(entity, map.worldPosition(tilePos));
    ecs.w.addContext(battle.TurnState.wait);
}

pub fn update(_: f32) void {
    const tilePosition = ecs.w.get(entity, map.Vec).?;
    var tilePos = tilePosition;
    if (window.isKeyRelease(.W)) tilePos.y -|= 1 //
    else if (window.isKeyRelease(.S)) tilePos.y += 1 //
    else if (window.isKeyRelease(.A)) tilePos.x -|= 1 //
    else if (window.isKeyRelease(.D)) tilePos.x += 1; //

    _ = ecs.w.removeIdentity(map.WantsToMove);
    if (!tilePosition.equals(tilePos)) {
        ecs.w.add(entity, map.WantsToMove{ .dest = tilePos });
        ecs.w.addIdentity(entity, map.WantsToMove);
        ecs.w.addContext(battle.TurnState.player);
    } else if (window.isKeyRelease(.SPACE)) {
        // 空格跳过当前回合
        ecs.w.addContext(battle.TurnState.player);
    }
}
```

## scene.zig

场景中新增了相机追踪的功能。

```zig
pub fn update(delta: f32) void {
    if (window.isKeyRelease(.H)) isHelp = !isHelp;
    if (window.isKeyRelease(.X)) isDebug = !isDebug;

    if (window.isKeyDown(.LEFT_ALT) and window.isKeyRelease(.ENTER)) {
        return window.toggleFullScreen();
    }

    const speed: f32 = std.math.round(100 * delta) / scale;
    if (window.isKeyDown(.UP)) camera.position.y -= speed;
    if (window.isKeyDown(.DOWN)) camera.position.y += speed;
    if (window.isKeyDown(.LEFT)) camera.position.x -= speed;
    if (window.isKeyDown(.RIGHT)) camera.position.x += speed;

    player.update(delta);
    const tilePos = ecs.w.get(player.entity, map.Vec).?;
    monster.move();
    monster.checkCollision(tilePos);
    map.update(delta);

    const playerWantMove = ecs.w.getIdentity(map.WantsToMove);
    if (playerWantMove) |_| cameraFollow();
    sceneCall("update", .{delta});
}

pub fn cameraFollow() void {
    const position = ecs.w.get(player.entity, gfx.Vector).?;

    const scaleSize = window.logicSize.div(camera.scale);
    const half = scaleSize.scale(0.5);
    const max = map.size.sub(scaleSize).max(.zero);
    camera.position = position.sub(half).clamp(.zero, max);
}
```

## 效果

修改了实现的方式，但是功能没有改变。

![移动消息][1]

[1]: images/地宫探险08.gif

## 附录
