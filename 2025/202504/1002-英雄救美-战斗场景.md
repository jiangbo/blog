# 1002-英雄救美-战斗场景

## 目标

绘制战斗场景，将双方的状态，头像等绘制出来。

## 环境

- Time 2025-08-21
- Zig 0.14.1

## 参考

1. 圣剑英雄传：英雄救美源码。

## 想法

只实现了绘制功能，剩下的控制和战斗功能，后面来完成。

## battle.zig

```zig
const std = @import("std");
const zhu = @import("zhu");

const window = zhu.window;
const gfx = zhu.gfx;
const camera = zhu.camera;

const scene = @import("scene.zig");
const map = @import("map.zig");
const context = @import("context.zig");
const npc = @import("npc.zig");
const player = @import("player.zig");
const menu = @import("menu.zig");

var enemy: u16 = 0;
var texture: gfx.Texture = undefined;
var menuNames: [4][]const u8 = .{ "攻击", "状态", "物品", "逃走" };
var menuIndex: u8 = 0;

pub fn init() void {
    std.log.info("battle init", .{});
    texture = gfx.loadTexture("assets/pic/fightbar.png", .init(448, 112));
}

pub fn enter() void {
    enemy = context.battleNpcIndex;
    map.linkIndex = 13;
    _ = map.enter();
    menu.active = 7;
}

pub fn update(delta: f32) void {
    if (window.isKeyRelease(.ESCAPE)) {
        scene.changeScene(.world);
    }

    _ = menu.update();

    _ = delta;
}

pub fn draw() void {
    map.draw();

    camera.mode = .local;
    defer camera.mode = .world;

    // 战斗人物
    camera.draw(player.battleTexture(), .init(130, 220));
    // 战斗 NPC
    camera.draw(npc.battleTexture(enemy), .init(465, 237));

    const position = gfx.Vector.init(96, 304);

    // 状态栏背景
    camera.draw(texture, position);
    // 角色的头像
    camera.draw(player.photo(), position.addXY(10, 10));

    var buffer: [100]u8 = undefined;
    const format = "生命：{:8}\n攻击：{:8}\n防御：{:8}\n等级：{:8}";
    var text = zhu.format(&buffer, format, .{
        player.health,
        player.attack,
        player.defend,
        player.level,
    });
    camera.drawColorText(text, position.addXY(50, 5), .black);

    // 敌人的头像
    const npcTexture = npc.photo(context.battleNpcIndex);
    camera.draw(npcTexture, position.addXY(265, 26));

    text = zhu.format(&buffer, format, .{
        npc.zon[enemy].health,
        npc.zon[enemy].attack,
        npc.zon[enemy].defend,
        npc.zon[enemy].level,
    });
    camera.drawColorText(text, position.addXY(305, 5), .black);

    menu.draw();
}

pub fn deinit() void {
    npc.deinit();
}
```

## 效果

![战斗场景][1]

[1]: images/英雄救美33.png

## 附录
