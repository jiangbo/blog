# 1008-地宫探险-解决移动闪烁

## 目标

前一节，在缩放的时候，移动相机会导致闪烁，这一节解决这个问题。

## 环境

- Time 2025-10-24
- Zig 0.15.2

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

应该是移动相机时，坐标不是整数导致，移动相机的坐标也做一次缩放。

## math.zig

在数学模块中新增了矩阵的相关计算。

```zig
pub const Matrix = struct {
    mat: [16]f32,

    pub const identity = Matrix{ .mat = [16]f32{
        1, 0, 0, 0,
        0, 1, 0, 0,
        0, 0, 1, 0,
        0, 0, 0, 1,
    } };

    pub fn orthographic(width: f32, height: f32, near: f32, far: f32) Matrix {
        return .{ .mat = [16]f32{
            2.0 / width, 0,             0,                   0,
            0,           -2.0 / height, 0,                   0,
            0,           0,             1.0 / (far - near),  0,
            -1.0,        1.0,           near / (near - far), 1,
        } };
    }

    pub fn mul(m1: Matrix, m2: Matrix) Matrix {
        var result: [16]f32 = undefined;
        for (0..4) |i| {
            for (0..4) |j| {
                var sum: f32 = 0;
                for (0..4) |k| {
                    sum += m1.mat[i + k * 4] * m2.mat[k + j * 4];
                }
                result[i + j * 4] = sum;
            }
        }
        return .{ .mat = result };
    }

    pub fn translate(x: f32, y: f32, z: f32) Matrix {
        return .{ .mat = [16]f32{
            1, 0, 0, 0,
            0, 1, 0, 0,
            0, 0, 1, 0,
            x, y, z, 1,
        } };
    }

    pub fn translateVec(vec: Vector3) Matrix {
        return translate(vec.x, vec.y, vec.z);
    }

    pub fn scale(x: f32, y: f32, z: f32) Matrix {
        return .{ .mat = [16]f32{
            x, 0, 0, 0,
            0, y, 0, 0,
            0, 0, z, 0,
            0, 0, 0, 1,
        } };
    }

    pub fn scaleVec(vec: Vector3) Matrix {
        return scale(vec.x, vec.y, vec.z);
    }
};
```

## player.zig

角色模块修改相机的追踪逻辑。

```zig
pub fn computePosition() void {
    position = map.playerWorldPosition(tilePosition);
    const scaleSize = window.logicSize.div(camera.scale);

    const half = scaleSize.scale(0.5);
    const max = map.size.sub(scaleSize).max(.zero);
    camera.position = position.sub(half).clamp(.zero, max);
}
```

## scene.zig

场景模块新增了相机的控制逻辑。

```zig
pub fn update(delta: f32) void {
    window.keepAspectRatio();
    if (window.isKeyRelease(.H)) isHelp = !isHelp;
    if (window.isKeyRelease(.X)) isDebug = !isDebug;

    if (window.isKeyDown(.LEFT_ALT) and window.isKeyRelease(.ENTER)) {
        return window.toggleFullScreen();
    }

    const speed: f32 = std.math.round(100 * delta) / scale;
    if (window.isKeyDown(.UP)) camera.position.y -= 1 * speed;
    if (window.isKeyDown(.DOWN)) camera.position.y += 1 * speed;
    if (window.isKeyDown(.LEFT)) camera.position.x -= 1 * speed;
    if (window.isKeyDown(.RIGHT)) camera.position.x += 1 * speed;

    player.update(delta);

    sceneCall("update", .{delta});
}
```

## 效果

![解决移动闪烁][1]

[1]: images/地宫探险04.gif

## 附录
