# 1089-幽灵逃生-音乐和音效

## 目标

进入场景时，播放背景音乐，其它合适的时候播放受伤、攻击等音效。

## 环境

- Time 2026-01-13
- Zig 0.15.1

## 参考

1. <https://www.bilibili.com/video/BV1jf9XYQEhW>

## 想法

教程中使用 SDL 来封装了播放声音的方法，这里直接使用自己的。

## scene.zig

播放背景音乐。

```zig
pub fn init() void {
    window.initText(@import("zon/font.zon"), 32);

    vertexBuffer = window.alloc(batch.Vertex, 5000);
    zhu.graphics.frameStats(true);
    batch.init(window.logicSize, vertexBuffer);
    batch.whiteImage = zhu.graphics.imageId("white.png");

    zhu.assets.loadAtlas(atlas);
    worldSize = window.logicSize.scale(3); // 设置世界大小

    zhu.window.bindAndUseMouseIcon(.CUSTOM_1, "assets/29.png");
    zhu.window.bindMouseIcon(.CUSTOM_2, "assets/30.png");

    player.init(worldSize.scale(0.5)); // 将玩家移动到世界中心
    enemy.init();
    battle.init();

    zhu.audio.playMusic("assets/bgm/OhMyGhost.ogg");
    zhu.audio.musicVolume = 0.4;
}
```

## player.zig

```zig
pub fn hurt(damage: u32) void {
    if (hurtTimer.isRunning()) return; // 受伤后的无敌时间

    stats.health -|= damage; // 扣除生命值
    hurtTimer.elapsed = 0; // 重置计时器
    if (stats.health == 0) {
        // 播放死亡音效
        zhu.audio.playSound("assets/sound/female-scream-02-89290.ogg");
    } else {
        // 播放受伤音效
        zhu.audio.playSound("assets/sound/hit-flesh-02-266309.ogg");
    }
}
```

## battle.zig

```zig
pub fn playerCastSpell(position: zhu.Vector2) void {
    if (mana < 30 or spellTimer.isRunning()) return;

    // 播放攻击音效
    zhu.audio.playSound("assets/sound/big-thunder.ogg");
    for (&spellPositions, &spellAnimations) |*pos, *ani| {
        if (ani.isFinished()) {
            pos.* = position;
            ani.reset();
            mana -= 30;
            spellTimer.elapsed = 0;
            return;
        }
    }
}
```

## enemy.zig

```zig
fn doSpawnEnemies() void {
    // 播放敌人生成音效
    zhu.audio.playSound("assets/sound/silly-ghost-sound-242342.ogg");
    for (&spawnEnemies) |*enemy| {
        const windowPos: zhu.Vector2 = .{
            .x = zhu.randomF32(0, zhu.window.logicSize.x),
            .y = zhu.randomF32(0, zhu.window.logicSize.y),
        };
        enemy.position = camera.toWorld(windowPos);
        enemy.stats = .{};
        enemy.animation = animations.get(.normal);
        const len = normalFrames.len;
        enemy.animation.index = zhu.randomInt(u8, 0, len);
    }
}
```

## 效果

音乐效果截图看不出来，图形效果和之前一样。

![音乐和音效][1]

[1]: images/幽灵逃生22.png

## 附录
