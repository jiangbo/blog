# 1126-阳光岛-单向平台碰撞

## 目标

实现单向平台的碰撞。

## 环境

- Time 2026-01-27
- Zig 0.15.1

## 参考

1. <https://www.bilibili.com/video/BV1jf9XYQEhW>

## 想法

解析了瓦片层中的数据，角色可以从下方穿过单向平台，但从上方落下时会与平台发生碰撞。

## map.zig

只粘贴了解析和碰撞的新增代码。

```zig
fn parseProperties(index: usize, tile: tiled.Tile) void {
    for (tile.properties) |property| {
        if (std.mem.eql(u8, property.name, "solid")) {
            if (property.value.bool) tileStates[index] = .solid;
        } else if (std.mem.eql(u8, property.name, "unisolid")) {
            if (property.value.bool) tileStates[index] = .uniSolid;
        } else if (std.mem.eql(u8, property.name, "slope")) {
            const value = property.value.string;
            tileStates[index] =
                if (std.mem.eql(u8, value, "0_1")) .slope_0_1 //
                else if (std.mem.eql(u8, value, "1_0")) .slope_1_0 //
                else if (std.mem.eql(u8, value, "0_2")) .slope_0_2 //
                else if (std.mem.eql(u8, value, "2_0")) .slope_2_0 //
                else if (std.mem.eql(u8, value, "2_1")) .slope_2_1 //
                else if (std.mem.eql(u8, value, "1_2")) .slope_1_2 //
                else unreachable; //
        } else tileStates[index] = .normal;
    }
}
...
fn clampY(old: Vector2, new: Vector2, size: Vector2) Vector2 {
    const w = map.width;

    const sz = size.add(epsilon);
    if (new.y < old.y) { // 向上移动
        var tileIndex = map.worldToTileIndex(new);
        if (tileStates[tileIndex] == .solid) { // 左上角碰撞
            return map.tileIndexToWorld(tileIndex + w);
        }
        tileIndex = map.worldToTileIndex(new.addX(sz.x));
        if (tileStates[tileIndex] == .solid) { // 右上角碰撞
            return map.tileIndexToWorld(tileIndex + w);
        }
    } else if (new.y > old.y) { // 向下移动
        var tileIndex = map.worldToTileIndex(new.addY(sz.y));
        const offset = map.tileSize.y - size.y;
        if (tileStates[tileIndex] == .solid or tileStates[tileIndex] == .uniSolid) {
            return map.tileIndexToWorld(tileIndex - w).addY(offset);
        }

        tileIndex = map.worldToTileIndex(new.add(sz));
        if (tileStates[tileIndex] == .solid or tileStates[tileIndex] == .uniSolid) {
            return map.tileIndexToWorld(tileIndex - w).addY(offset);
        }
    }
    return new;
}
```

## 效果

![单向平台碰撞][1]

[1]: images/阳光岛24.gif

## 附录
