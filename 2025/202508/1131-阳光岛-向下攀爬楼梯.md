# 1131-阳光岛-向下攀爬楼梯

## 目标

实现了角色可以向下攀爬楼梯。

## 环境

- Time 2026-01-29
- Zig 0.15.1

## 参考

1. <https://www.bilibili.com/video/BV1jf9XYQEhW>

## 想法

这个游戏的各种物理计算状态太多了，不想处理了，很乱，先就这样吧。

## map.zig

我也不清楚这个行不行，也不清楚是否有问题，不过就这样了。

```zig
pub fn update(delta: f32) void {
    hurtTimer.update(delta);
    state.update(delta);

    velocity = velocity.add(force.scale(delta));
    velocity.x = std.math.clamp(velocity.x, -maxSpeed, maxSpeed);
    var toPosition = position.add(velocity.scale(delta));
    // 角色不移动到屏幕外
    const max = batch.camera.bound.x - tiledObject.size.x;
    toPosition.x = std.math.clamp(toPosition.x, 0, max);

    if (state == .dead) position = toPosition else {
        const size = tiledObject.size;
        const onTop = map.isTopLadder(toPosition, size);
        if (state != .climb and onTop) {
            velocity.y = 0;
            position = .xy(toPosition.x, position.y);
            const canClimb = map.canClimb(toPosition, size);
            if (zhu.window.isKeyDown(.S) and canClimb) {
                changeState(.climb);
                position = toPosition;
            }
        } else {
            const clamped = map.clamp(position, toPosition, size);
            if (clamped.x == position.x) velocity.x = 0;
            if (clamped.y == position.y) velocity.y = 0;
            position = clamped;
        }
    }
    if (state == .climb) {
        if (toPosition.y > position.y) changeState(.idle);
        velocity = .zero;
    } else force.y = gravity;

    batch.camera.directFollow(position);
    batch.camera.position = batch.camera.position.round();
}
```

## 效果

![向下攀爬楼梯][1]

[1]: images/阳光岛29.gif

## 附录
