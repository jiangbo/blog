# 1140-阳光岛-暂停菜单功能

## 目标

游戏的过程中，可以按 ESC 来暂停游戏，并且显示一个暂停的菜单。

## 环境

- Time 2026-01-31
- Zig 0.15.1

## 参考

1. <https://www.bilibili.com/video/BV1jf9XYQEhW>

## 想法

基于之前标题场景的菜单来做，不是很复杂。

## scene.zig

实现了暂停场景的显示和对应按钮的功能。

```zig
const std = @import("std");
const zhu = @import("zhu");

const window = zhu.window;
const batch = zhu.batch;

const title = @import("title.zig");
const map = @import("map.zig");
const menu = @import("menu.zig");
const player = @import("player.zig");
const object = @import("object.zig");

const Session = extern struct {
    level: u8 = 0,
    health: u8 = 3,
    score: u32 = 0,
    highScore: u32 = 0,
};

const StateEnum = enum { title, play, pause, over };

const savePath = "save/save.dat";
var session: Session = .{};
var state: StateEnum = .title;

pub fn init() void {
    if (state == .title) return title.init();

    menu.menuIndex = 1;
    map.init(session.level);

    for (map.objects.items, 0..) |obj, index| {
        if (obj.type != .player) continue;
        player.init(obj.position, obj.size);
        player.health = session.health;
        player.score = session.score;
        _ = map.objects.swapRemove(index);
        break;
    }
    object.init(map.objects);

    zhu.audio.playMusic("assets/audio/hurry_up_and_run.ogg");
}

pub fn start() void {
    state = .play;
    session = .{};
    init();
}

pub fn load() void {
    state = .play;
    session = loadSession();
    init();
}

fn loadSession() Session {
    var buffer: [64]u8 = undefined;
    const content = zhu.window.readBuffer(savePath, &buffer) catch {
        return .{};
    };

    var reader = std.Io.Reader.fixed(content);
    return reader.takeStruct(Session, .little) catch unreachable;
}

fn saveSession() !void {
    session.health = player.health;
    session.score = player.score;
    session.highScore = @max(player.score, session.highScore);

    var buffer: [64]u8 = undefined;
    var writer = std.Io.Writer.fixed(&buffer);
    try writer.writeStruct(session, .little);

    try zhu.window.saveAll(savePath, buffer[0..writer.end]);
}

pub fn changeNextLevel() void {
    session.level += 1;
    saveSession() catch unreachable;
    init();
}

fn backToTitle() void {
    state = .title;
    init();
}

pub fn deinit() void {
    map.deinit();
}

pub fn update(delta: f32) void {
    if (window.isKeyDown(.LEFT_ALT) and window.isKeyReleased(.ENTER)) {
        return window.toggleFullScreen();
    }

    switch (state) {
        .title => title.update(delta),
        .play => {
            player.update(delta);
            object.update(delta);
            if (zhu.window.isKeyReleased(.ESCAPE)) state = .pause;
        },
        .pause => {
            if (menu.update()) |event| {
                switch (event) {
                    0 => state = .play, // 继续游戏
                    1 => saveSession() catch unreachable, // 保存存档
                    2 => backToTitle(), // 返回标题
                    3 => zhu.window.exit(), // 退出游戏
                    else => unreachable,
                }
            }
        },
        .over => {},
    }
}

pub fn draw() void {
    zhu.batch.beginDraw(.black);
    defer zhu.batch.endDraw();

    if (state == .title) return title.draw();

    map.draw();
    object.draw();
    player.draw();

    if (state == .pause) {
        const size = zhu.window.size;
        const pos: zhu.Vector2 = .xy(size.x * 0.5, size.y * 0.2);
        zhu.text.drawTextCenter("PAUSE", pos, .{ .size = 32 });
        menu.draw();
    }
}

fn drawHelpInfo() void {
    const text =
        \\按键说明：
        \\上：W，下：S，左：A，右：D
        \\确定：F，取消：Q，菜单：E
        \\帮助：H  按一次打开，再按一次关闭
    ;
    zhu.text.drawColor(text, .xy(10, 10), .green);
}
```

## 效果

![暂停菜单功能][1]

[1]: images/阳光岛37.png

## 附录
