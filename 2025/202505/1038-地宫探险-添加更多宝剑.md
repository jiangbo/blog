# 1038-地宫探险-添加更多宝剑

## 目标

在物品中新增了宝剑物品，角色拾取并且使用后，攻击力可以改变。

## 环境

- Time 2025-11-25
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

越到底层，生成的物品越多，还是能打过去的，一些强大的怪兽，可以不打，或者攻击力高了打。

## templates.zon

新增了三种宝剑。

```zig
.{
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Weak Healing Potion",
        .tile = .heal,
        .value = 2,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Healing Potion",
        .tile = .heal,
        .value = 6,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 1,
        .name = "Zig Sword",
        .damage = 2,
        .tile = .zigSword,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 1,
        .damage = 3,
        .name = "Shiny Sword",
        .tile = .shinySword,
    },
    .{
        .entityType = .item,
        .levels = .{ 2, 3 },
        .frequency = 1,
        .damage = 4,
        .name = "Huge Sword",
        .tile = .hugeSword,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 1,
        .name = "Dungeon Map",
        .tile = .map,
    },
    .{
        .entityType = .enemy,
        .levels = .{1},
        .frequency = 3,
        .name = "Goblin",
        .tile = .goblin,
        .damage = 1,
        .value = 1,
    },
    .{
        .entityType = .enemy,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Orc",
        .tile = .orc,
        .damage = 1,
        .value = 2,
    },
    .{
        .entityType = .enemy,
        .levels = .{ 2, 3 },
        .frequency = 1,
        .name = "Ogre",
        .tile = .ogre,
        .damage = 2,
        .value = 5,
    },
    .{
        .entityType = .enemy,
        .levels = .{3},
        .frequency = 1,
        .name = "Ettin",
        .tile = .ettin,
        .damage = 3,
        .value = 10,
    },
}
```

## monster.zig

如果是武器，新增了一个 Damage 组件。

```zig
const Template = struct {
    entityType: enum { enemy, item },
    levels: []const u8,
    frequency: u8,
    damage: u8 = 0,
    name: []const u8,
    tile: Tile,
    value: u8 = 0,
};
const templates: []const Template = @import("zon/templates.zon");
var frequencies: [templates.len]u8 = undefined;

pub fn init() void {
    for (templates, &frequencies) |template, *f| {
        const contains = std.mem.indexOfScalar;
        const found = contains(u8, template.levels, map.currentLevel);
        f.* = if (found == null) 0 else template.frequency;
    }

    const playerView = ecs.w.getIdentity(Player, ViewField).?[0];
    for (map.spawns[1..]) |pos| {
        const entity = ecs.w.createEntity();
        if (playerView.contains(pos)) ecs.w.add(entity, PlayerView{});

        const index = zhu.random().weightedIndex(u8, &frequencies);
        const template = &templates[index];
        ecs.w.add(entity, pos);
        ecs.w.add(entity, map.worldPosition(pos));
        ecs.w.add(entity, map.getTextureFromTile(template.tile));
        ecs.w.add(entity, Name{template.name});

        switch (templates[index].entityType) {
            .item => spawnItem(entity, template),
            .enemy => spawnMonster(entity, template),
        }
    }
}

fn spawnItem(entity: ecs.Entity, t: *const Template) void {
    ecs.w.add(entity, Item{});
    if (t.tile == .map) return;
    if (t.damage == 0) {
        return ecs.w.add(entity, Healing{ .v = t.value });
    }
    ecs.w.add(entity, Damage{ .v = t.damage });
}

fn spawnMonster(enemy: ecs.Entity, t: *const Template) void {
    const hp: i32 = @intCast(t.value);
    ecs.w.add(enemy, Health{ .current = hp, .max = hp });
    ecs.w.add(enemy, ChasePlayer{});
    ecs.w.add(enemy, Enemy{});
    ecs.w.add(enemy, Damage{ .v = t.damage });
}
```

## 效果

![添加更多宝剑][1]

[1]: images/地宫探险33.gif

## 附录
