# 1030-地宫探险-设计地图物品

## 目标

在地图中新增加两种地图物品，目前只能进行显示，还没有功能。

## 环境

- Time 2025-11-22
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

感觉写的 ECS 和面向对象混合着写的，不过没关系，慢慢了解这两种，看看哪个好。

## item.zig

物品模块新增了 update 方法，在角色进行移动后更新。

```zig
const std = @import("std");
const zhu = @import("zhu");

const gfx = zhu.gfx;
const ecs = zhu.ecs;

const map = @import("map.zig");
const component = @import("component.zig");

const TilePosition = component.TilePosition;
const Amulet = component.Amulet;
const Player = component.Player;
const PlayerView = component.PlayerView;
const ViewField = component.ViewField;
const Item = component.Item;

pub fn init() void {
    const amulet = ecs.w.createIdentityEntity(Amulet);

    const pos = map.amuletPos;
    ecs.w.add(amulet, pos);
    const texture = map.getTextureFromTile(.amulet);
    ecs.w.alignAdd(amulet, .{ map.worldPosition(pos), texture });
    ecs.w.add(amulet, Item{});
}

pub fn update() void {
    const playerEntity = ecs.w.getIdentityEntity(Player).?;
    const playerPos = ecs.w.get(playerEntity, TilePosition);
    const viewField = ecs.w.get(playerEntity, ViewField)[0];

    var view = ecs.w.viewOptions(.{Item}, .{PlayerView}, .{});
    while (view.next()) |item| {
        const itemPos = view.get(item, TilePosition);
        if (viewField.contains(itemPos)) {
            view.add(item, PlayerView{});
        }
    }
    _ = playerPos;
}
```

## monster.zig

怪物模块的一些位置，目前用来生成地图上的物品。

```zig
pub fn init() void {
    const playerView = ecs.w.getIdentity(Player, ViewField).?[0];

    const mapItemIndex = zhu.randomInt(u8, 5, map.spawns.len);

    for (map.spawns[1..], 1..) |pos, index| {
        const enemy = ecs.w.createEntity();

        if (playerView.contains(pos)) ecs.w.add(enemy, PlayerView{});
        ecs.w.add(enemy, pos);
        ecs.w.add(enemy, map.worldPosition(pos));

        if (index == mapItemIndex) {
            ecs.w.add(enemy, map.getTextureFromTile(.map));
            ecs.w.add(enemy, Item{});
            ecs.w.add(enemy, Name{"Map"});
            continue;
        }

        switch (zhu.randomInt(u8, 0, 6)) {
            0 => spawnHeal(enemy),
            else => spawnMonster(enemy),
        }
    }
}

fn spawnHeal(entity: ecs.Entity) void {
    ecs.w.add(entity, map.getTextureFromTile(.heal));
    ecs.w.add(entity, Item{});
    ecs.w.add(entity, Name{"healing potion"});
}

fn spawnMonster(enemy: ecs.Entity) void {
    const enemyTile = switch (zhu.randomIntMost(u8, 1, 10)) {
        0...8 => Tile.goblin,
        else => Tile.orc,
    };

    const hp: i32 = switch (enemyTile) {
        Tile.goblin => 1,
        Tile.orc => 2,
        else => unreachable,
    };
    ecs.w.add(enemy, Health{ .current = hp, .max = hp });
    ecs.w.add(enemy, Name{@tagName(enemyTile)});

    ecs.w.add(enemy, map.getTextureFromTile(enemyTile));
    ecs.w.add(enemy, ChasePlayer{});
    ecs.w.add(enemy, Enemy{});
}
```

## 效果

![设计地图物品][1]

[1]: images/地宫探险25.gif

## 附录
