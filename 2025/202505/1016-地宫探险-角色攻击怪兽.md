# 1016-地宫探险-角色攻击怪兽

## 目标

检查角色移动的目的地是否是怪兽，如果是则进行攻击。

## 环境

- Time 2025-11-05
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

实现这个可以有两种方式，一种是将攻击附加到攻击的实体上，一种是以消息发布，先试试第一种。

## battle.zig

新增了 WantToAttack 组件，如果攻击则减少血量 1。

```zig
const std = @import("std");
const zhu = @import("zhu");

const ecs = zhu.ecs;

const components = @import("components.zig");

const Player = components.Player;
const Enemy = components.Enemy;
const WantToMove = components.WantToMove;
const TilePosition = components.TilePosition;
const WantToAttack = components.WantToAttack;
const Health = components.Health;

pub fn checkPlayerAttack() void {
    const entity = ecs.w.getIdentityEntity(Player).?;

    const moved = ecs.w.get(entity, WantToMove) orelse return;
    const tilePosition = moved[0];

    var view = ecs.w.view(.{ Enemy, TilePosition });
    while (view.next()) |enemy| {
        const position = view.get(enemy, TilePosition);
        if (!tilePosition.equals(position)) continue;

        const enemyEntity = ecs.w.toEntity(enemy).?;
        ecs.w.add(entity, WantToAttack{enemyEntity});
        ecs.w.remove(entity, WantToMove);
        return;
    }
}

pub fn attack() void {
    var view = ecs.w.view(.{WantToAttack});
    while (view.next()) |entity| {
        const target = view.get(entity, WantToAttack)[0];

        var health = ecs.w.getPtr(target, Health) orelse continue;
        health.current -|= 1;
        if (health.current == 0) ecs.w.destroyEntity(target);
    }
    ecs.w.clear(WantToAttack);
}
```

## scene.zig

新增了攻击检测和判断的两个方法。

```zig
pub fn update(delta: f32) void {
    if (window.isKeyRelease(.H)) isHelp = !isHelp;
    if (window.isKeyRelease(.X)) isDebug = !isDebug;

    if (window.isKeyDown(.LEFT_ALT) and window.isKeyRelease(.ENTER)) {
        return window.toggleFullScreen();
    }

    const speed: f32 = std.math.round(100 * delta) / scale;
    if (window.isKeyDown(.UP)) camera.position.y -= speed;
    if (window.isKeyDown(.DOWN)) camera.position.y += speed;
    if (window.isKeyDown(.LEFT)) camera.position.x -= speed;
    if (window.isKeyDown(.RIGHT)) camera.position.x += speed;

    player.move();
    battle.checkPlayerAttack();
    battle.attack();
    monster.move();
    map.update(delta);

    cameraFollow();
    sceneCall("update", .{delta});
}
```

## 效果

![角色攻击怪兽][1]

[1]: images/地宫探险11.gif

## 附录
