# 1024-地宫探险-限制怪兽视野

## 目标

给怪兽添加一个视野限制，角色在怪兽视野之外，则不会发起追踪。

## 环境

- Time 2025-11-19
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

角色的视野比怪兽要大一格，看见了可以等待。不过这个游戏感觉只要等待满血，然后就可以了？

## monster.zig

没有给怪兽增加视野组件，直接在移动模块中判断的。

```zig
fn moveOrAttack() void {
    const playerEntity = ecs.w.getIdentityEntity(Player).?;
    const playerPos = ecs.w.get(playerEntity, TilePosition).?;
    const rect = ecs.w.get(playerEntity, ViewField).?[0];

    var view = ecs.w.view(.{ ChasePlayer, TilePosition });
    while (view.next()) |entity| {
        var pos = view.get(entity, TilePosition);
        if (rect.contains(pos)) view.add(entity, PlayerView{});
        const enemyRect: TileRect = .fromCenter(pos, viewSize);
        if (!enemyRect.contains(playerPos)) continue;

        const next = map.queryLessDistance(pos) orelse continue;

        if (playerPos.equals(next)) {
            view.add(entity, WantToAttack{playerEntity});
            continue;
        }

        for (ecs.w.raw(TilePosition)) |tilePos| {
            if (!tilePos.equals(next)) continue;

            const step = zhu.math.randomStep(u8, 1);
            if (pos.x == next.x) pos.x +%= step else pos.y +%= step;
            view.add(entity, WantToMove{pos});
            break;
        } else view.add(entity, WantToMove{next});
    }
}
```

## 效果

![限制怪兽视野][1]

[1]: images/地宫探险19.gif

## 附录
