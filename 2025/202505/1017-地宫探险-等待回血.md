# 1017-地宫探险-等待回血

## 目标

角色可以按空格进行等待，并且可以回血。

## 环境

- Time 2025-11-05
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

感觉移动存在问题，检测移动前的位置还是移动后的位置呢？

## player.zig

按空格进行等待，等待的时候回血。

```zig
const std = @import("std");
const zhu = @import("zhu");

const gfx = zhu.gfx;
const window = zhu.window;
const camera = zhu.camera;
const ecs = zhu.ecs;

const map = @import("map.zig");
const components = @import("components.zig");

const Player = components.Player;
const Health = components.Health;
const TurnState = components.TurnState;
const TilePosition = components.TilePosition;
const WantToMove = components.WantToMove;

pub fn init() void {
    const entity = ecs.w.createEntity();
    ecs.w.addIdentity(entity, Player);

    const tilePosition = map.rooms[0].center();
    ecs.w.add(entity, tilePosition);
    ecs.w.add(entity, WantToMove{tilePosition});
    ecs.w.add(entity, map.getTextureFromTile(.player));
    ecs.w.add(entity, map.worldPosition(tilePosition));
    const health: Health = .{ .max = 20, .current = 10 };
    ecs.w.add(entity, health);
    ecs.w.addContext(TurnState.wait);
}

pub fn move() void {
    const entity = ecs.w.getIdentityEntity(components.Player).?;

    const tilePosition = ecs.w.get(entity, TilePosition).?;
    var tilePos = tilePosition;
    if (window.isKeyRelease(.W)) tilePos.y -|= 1 //
    else if (window.isKeyRelease(.S)) tilePos.y += 1 //
    else if (window.isKeyRelease(.A)) tilePos.x -|= 1 //
    else if (window.isKeyRelease(.D)) tilePos.x += 1; //

    _ = ecs.w.removeIdentity(WantToMove);
    if (!tilePosition.equals(tilePos)) {
        ecs.w.add(entity, WantToMove{tilePos});
        ecs.w.addContext(TurnState.player);
    } else if (window.isKeyRelease(.SPACE)) {
        // 空格跳过当前回合
        ecs.w.addContext(TurnState.player);
        var health = ecs.w.getPtr(entity, Health).?;
        health.current = @min(health.max, health.current + 1);
    }
}
```

## 效果

![等待回血][1]

[1]: images/地宫探险12.gif

## 附录
