# 1031-地宫探险-拾取地图物品

## 目标

角色在地图上行走的时候，如果脚底有物品，可以按 G 键进行拾取。

## 环境

- Time 2025-11-22
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

如果使用了物品，感觉要保证物品有序，要实现一个顺序删除的功能。

## hud.zig

新增了绘制拾取的物品的功能。

```zig
fn drawCarriedItemIfNeed() void {
    var view = ecs.w.view(.{ Item, Name, Carried });
    var index: u8 = 1;
    var buffer: [44]u8 = undefined;
    while (view.next()) |entity| : (index += 1) {
        const name = view.get(entity, Name)[0];
        const offset: f32 = @floatFromInt(index * 16);
        const pos = gfx.Vector.init(30, 20 + offset);
        const text = zhu.format(&buffer, "{}: {s}", .{ index, name });
        drawText(text, pos, .{});
    }
    if (index == 1) return;

    const pos = gfx.Vector.init(15, 15);
    drawText("Items carried", pos, .{ .color = .yellow });
    const offset: f32 = @floatFromInt(index * 16 + 15);
    drawText("Number to use", pos.addY(offset), .{ .color = .yellow });
}
```

## player.zig

新增了拾取物品的功能。

```zig
    const playerPos = ecs.w.get(entity, TilePosition);
    if (window.isKeyRelease(.G)) { // 拾取物品
        // 找到在角色视野中的物品，判断是否可以拾取
        var view = ecs.w.view(.{ Item, TilePosition, PlayerView });
        while (view.next()) |itemEntity| {
            const pos = view.get(itemEntity, TilePosition);
            if (!playerPos.equals(pos)) continue;
            // 找到一个物品可以拾取
            ecs.w.addContext(TurnState.monster);
            view.remove(itemEntity, PlayerView);
            view.remove(itemEntity, TilePosition);
            view.remove(itemEntity, Position);
            view.add(itemEntity, Carried{});
            return;
        }
    }
```

## 效果

![拾取地图物品][1]

[1]: images/地宫探险26.gif

## 附录
