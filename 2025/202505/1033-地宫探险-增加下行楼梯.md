# 1033-地宫探险-增加下行楼梯

## 目标

每个关卡增加一个楼梯，可以进入新的关卡，除了最后一关。

## 环境

- Time 2025-11-24
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

只实现了下行，不能够返回上去，所以不用保持之前的地图的状态。

## item.zig

根据当前关卡来判断生成物品。

```zig
pub fn init() void {
    if (map.currentLevel == map.MAX_LEVEL) {
        spawnAmulet();
    } else {
        spawnExit();
    }
}

fn spawnAmulet() void {
    const amulet = ecs.w.createIdentityEntity(Amulet);

    const pos = map.finalPos;
    ecs.w.add(amulet, pos);
    const texture = map.getTextureFromTile(.amulet);
    ecs.w.alignAdd(amulet, .{ map.worldPosition(pos), texture });
    ecs.w.add(amulet, Item{});
}

fn spawnExit() void {
    const exit = ecs.w.createEntity();

    const pos = map.finalPos;
    ecs.w.add(exit, pos);
    const texture = map.getTextureFromTile(.exit);
    ecs.w.alignAdd(exit, .{ map.worldPosition(pos), texture });
    ecs.w.add(exit, Item{});
}
```

## player.zig

还没有处理遇到楼梯的情况。

```zig
    var newPos = playerPos;
    if (window.isKeyRelease(.W)) newPos.y -|= 1 //
    else if (window.isKeyRelease(.S)) newPos.y += 1 //
    else if (window.isKeyRelease(.A)) newPos.x -|= 1 //
    else if (window.isKeyRelease(.D)) newPos.x += 1; //

    if (playerPos.equals(newPos)) return; // 没有移动

    if (map.finalPos.equals(newPos)) {
        if (map.currentLevel == map.MAX_LEVEL) {
            ecs.w.addContext(TurnState.win);
        } else {
            // TODO next level
        }
    } else moveOrAttack(newPos);

    battle.attack();
```

## 效果

![增加下行楼梯][1]

[1]: images/地宫探险28.gif

## 附录
