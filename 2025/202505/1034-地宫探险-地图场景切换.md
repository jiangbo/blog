# 1034-地宫探险-地图场景切换

## 目标

通过地图上的楼梯时，可以进入下一关，并且拾取的物品可以保留。

## 环境

- Time 2025-11-24
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

有两种保留数据的方法，一种是重新创建 world，另一种是销毁不用的，这里选择的第一种。

## scene.zig

场景中实现了进入下一关的逻辑。

```zig
fn restart(mapLevel: u8) void {
    ecs.clear();
    initWorld(mapLevel);
}

fn initWorld(mapLevel: u8) void {
    ecs.w.addContext(TurnState.player);
    hud.init();
    map.init(mapLevel);
    player.init();
    item.init();
    monster.init();
}

fn nextLevel() void {
    // 保留拾取的物品，不要地图
    var reg = ecs.Registry.init(window.allocator);
    var view = ecs.w.view(.{ component.Carried, component.Healing });
    while (view.next()) |entity| {
        const newEntity = reg.createEntity();
        reg.add(newEntity, component.Carried{});
        reg.add(newEntity, component.Item{});
        reg.add(newEntity, view.get(entity, component.Healing));
        reg.add(newEntity, view.get(entity, component.Name));
    }
    ecs.w.deinit();
    ecs.registry = reg;
    // 保留地图等级
    initWorld(map.currentLevel + 1);
}
```

## 效果

![地图场景切换][1]

[1]: images/地宫探险29.gif

## 附录
