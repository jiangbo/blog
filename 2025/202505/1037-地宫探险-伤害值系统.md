# 1037-地宫探险-伤害值系统

## 目标

之前的伤害都是 1，现在新增一个伤害值系统，可以造成更多的伤害。

## 环境

- Time 2025-11-25
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

感觉根据书上的定义，怪兽好像强大得过分了，打不过。

## templates.zon

新增了两个怪兽，调整了怪兽所在的关卡。

```zig
.{
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Weak Healing Potion",
        .tile = .heal,
        .value = 2,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Healing Potion",
        .tile = .heal,
        .value = 6,
    },
    .{
        .entityType = .item,
        .levels = .{ 1, 2, 3 },
        .frequency = 1,
        .name = "Dungeon Map",
        .tile = .map,
        .value = 0,
    },
    .{
        .entityType = .enemy,
        .levels = .{1},
        .frequency = 3,
        .name = "Goblin",
        .tile = .goblin,
        .damage = 1,
        .value = 1,
    },
    .{
        .entityType = .enemy,
        .levels = .{ 1, 2, 3 },
        .frequency = 2,
        .name = "Orc",
        .tile = .orc,
        .damage = 1,
        .value = 2,
    },
    .{
        .entityType = .enemy,
        .levels = .{ 2, 3 },
        .frequency = 1,
        .name = "Ogre",
        .tile = .ogre,
        .damage = 2,
        .value = 5,
    },
    .{
        .entityType = .enemy,
        .levels = .{3},
        .frequency = 1,
        .name = "Ettin",
        .tile = .ettin,
        .damage = 3,
        .value = 10,
    },
}
```

## battle.zig

使用 Damage 组件来造成伤害值，而不是固定值。

```zig

pub fn attack() void {
    var view = ecs.w.view(.{ WantToAttack, component.Damage });
    while (view.next()) |entity| {
        const target = view.get(entity, WantToAttack)[0];

        var health = ecs.w.tryGetPtr(target, Health) orelse continue;
        const damage = view.get(entity, component.Damage);
        health.current -= damage.amount;
        if (health.current <= 0) {
            if (ecs.w.isIdentity(target, Player)) {
                ecs.w.addContext(TurnState.over);
            } else ecs.w.destroyEntity(target);
        }
    }
    ecs.w.clear(WantToAttack);
}
```

## 效果

![伤害值系统][1]

[1]: images/地宫探险32.gif

## 附录
