# 1032-地宫探险-使用拾取物品

## 目标

如果角色拾取了物品，可以按对应的按键进行使用。

## 环境

- Time 2025-11-24
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

目前做的，感觉越来越面向对象了，ECS用起来不太方便，后续再看看。

## player.zig

角色新增了可以使用物品的功能，去掉了等待回血的机制。

```zig
pub fn update() void {
    if (!window.isAnyRelease()) return; // 没有按任何键

    if (window.isAnyKeyRelease(&.{ .ESCAPE, .Q })) {
        map.minMap = false;
    }

    const playerPos = ecs.w.get(entity, TilePosition);
    if (window.isKeyRelease(.G)) { // 拾取物品
        // 找到在角色视野中的物品，判断是否可以拾取
        var view = ecs.w.view(.{ Item, TilePosition, PlayerView });
        while (view.next()) |itemEntity| {
            const pos = view.get(itemEntity, TilePosition);
            if (!playerPos.equals(pos)) continue;
            // 找到一个物品可以拾取
            ecs.w.addContext(TurnState.monster);
            view.remove(itemEntity, PlayerView);
            view.remove(itemEntity, TilePosition);
            view.remove(itemEntity, Position);
            view.add(itemEntity, Carried{});
            return;
        }
    }

    const start: u32 = @intFromEnum(zhu.input.KeyCode._0);
    var view = ecs.w.view(.{ Item, Carried });
    var index: u8 = 1;
    while (view.next()) |itemEntity| : (index += 1) {
        if (!window.isKeyRelease(@enumFromInt(start + index))) continue;

        if (view.tryGet(itemEntity, Healing)) |heal| { // 使用药水
            const h = ecs.w.getPtr(entity, Health);
            h.current = @min(h.max, h.current + heal.amount);
            view.orderedRemove(itemEntity, Carried);
            view.destroy(itemEntity);
            ecs.w.addContext(TurnState.monster);
            return;
        }

        if (view.is(itemEntity, component.Map)) { // 使用地图
            map.minMap = !map.minMap;
            return;
        }
    }

    var newPos = playerPos;
    if (window.isKeyRelease(.W)) newPos.y -|= 1 //
    else if (window.isKeyRelease(.S)) newPos.y += 1 //
    else if (window.isKeyRelease(.A)) newPos.x -|= 1 //
    else if (window.isKeyRelease(.D)) newPos.x += 1; //

    if (playerPos.equals(newPos)) return; // 没有移动

    if (map.amuletPos.equals(newPos)) {
        ecs.w.addContext(TurnState.win);
    } else moveOrAttack(newPos);

    battle.attack();
}
```

## hud.zig

绘制物品的时候，根据 Carried 拾取的顺序来进行绘制，保持物品的顺序。

```zig
fn drawCarriedItemIfNeed() void {
    var view = ecs.w.viewOption(.{ Carried, Item, Name }, .{}, .{
        .useFirst = true,
    });
    var index: u8 = 1;
    var buffer: [44]u8 = undefined;
    while (view.next()) |entity| : (index += 1) {
        const name = view.get(entity, Name)[0];
        const offset: f32 = @floatFromInt(index * 16);
        const pos = gfx.Vector.init(30, 20 + offset);
        const text = zhu.format(&buffer, "{}: {s}", .{ index, name });
        drawText(text, pos, .{});
    }
    if (index == 1) return;

    const pos = gfx.Vector.init(15, 15);
    drawText("Items carried", pos, .{ .color = .yellow });
    const offset: f32 = @floatFromInt(index * 16 + 15);
    drawText("Number to use", pos.addY(offset), .{ .color = .yellow });
}
```

## 效果

![使用拾取物品][1]

[1]: images/地宫探险27.gif

## 附录
