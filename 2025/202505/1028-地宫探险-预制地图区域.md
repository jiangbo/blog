# 1028-地宫探险-预制地图区域

## 目标

固定一个地图区域，生成地图的时候，将固定的区域放置进去。

## 环境

- Time 2025-11-21
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

区域可能找得到放置的地方，也可能找不到，而且如果地图有些地方没有连通怎么办呢？

## map.zig

新增了生成预制区域的功能，并且随机选择了生成地图的算法。

```zig
pub fn init() void {
    texture = gfx.loadTexture("assets/dungeonfont.png", .init(512, 512));

    switch (zhu.randomInt(u8, 0, 3)) {
        1 => builder.buildRooms(&tiles, &spawns),
        2 => builder.buildAutometa(&tiles, &spawns),
        else => builder.buildDrunkard(&tiles, &spawns),
    }

    @memset(&walks, false);
    updateDistance(spawns[0]);

    var max: u8 = 0;
    for (&distances, 0..) |*line, y| {
        for (line, 0..) |value, x| {
            if (value == 0xFF or value <= max) continue;
            max = value;
            amuletPos = .{ .x = @intCast(x), .y = @intCast(y) };
        }
    }

    applyPrefab();
}

const FORTRESS: [11][12]u8 = .{
    .{ 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46 },
    .{ 46, 46, 46, 35, 35, 35, 35, 35, 35, 46, 46, 46 },
    .{ 46, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46 },
    .{ 46, 46, 46, 35, 46, 79, 46, 46, 35, 46, 46, 46 },
    .{ 46, 35, 35, 35, 46, 46, 46, 46, 35, 35, 35, 46 },
    .{ 46, 46, 79, 46, 46, 46, 46, 46, 46, 79, 46, 46 },
    .{ 46, 35, 35, 35, 46, 46, 46, 46, 35, 35, 35, 46 },
    .{ 46, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46 },
    .{ 46, 46, 46, 35, 46, 46, 46, 46, 35, 46, 46, 46 },
    .{ 46, 46, 46, 35, 35, 35, 35, 35, 35, 46, 46, 46 },
    .{ 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46, 46 },
};

fn applyPrefab() void {
    var rect: ?TileRect = null;

    blk: for (0..10) |_| {
        const prefab = TileRect{
            .x = zhu.randomInt(u8, 0, WIDTH - FORTRESS[0].len),
            .y = zhu.randomInt(u8, 0, HEIGHT - FORTRESS.len),
            .w = FORTRESS[0].len,
            .h = FORTRESS.len,
        };

        if (prefab.contains(amuletPos)) continue;
        for (prefab.y..prefab.y + prefab.h) |y| {
            for (prefab.x..prefab.x + prefab.w) |x| {
                const distance = distances[y][x];
                if (distance != 0xFF and distance > 20) {
                    rect = prefab;
                    break :blk;
                }
            }
        }
    }
    if (rect == null) return; // 没有找到放置的地方

    var prefabSpawnsArray: [3]usize = .{ 0, 0, 0 };
    var count: usize = 0;
    for (spawns[1..], 1..) |pos, index| {
        if (rect.?.contains(pos)) {
            prefabSpawnsArray[count] = index;
            count += 1;
        }
    }

    const prefabSpawns = prefabSpawnsArray[0..count];
    count = 0;

    const start = TilePosition{ .x = rect.?.x, .y = rect.?.y };
    for (0..FORTRESS.len) |y| {
        for (0..FORTRESS[0].len) |x| {
            const index = indexUsize(start.x + x, start.y + y);
            if (FORTRESS[y][x] == 79) {
                const i = if (count < prefabSpawns.len)
                    prefabSpawns[count]
                else
                    zhu.randomInt(u8, 1, spawns.len);
                const dx: u8 = @intCast(start.x + x);
                spawns[i] = .{ .x = dx, .y = @intCast(start.y + y) };
                count += 1;
                tiles[index] = .floor;
            } else tiles[index] = @enumFromInt(FORTRESS[y][x]);
        }
    }
}
```

## 效果

![预制地图区域][1]

[1]: images/地宫探险23.gif

## 附录
