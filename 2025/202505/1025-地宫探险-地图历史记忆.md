# 1025-地宫探险-地图历史记忆

## 目标

如果是走过的地图，也进行渲染，只不过使用更暗的颜色进行绘制。

## 环境

- Time 2025-11-19
- Zig 0.15.1

## 参考

1. <https://pragprog.com/titles/hwrust/hands-on-rust/>
2. 《Rust游戏开发实战》

## 想法

没有做可见性剔除，目前是所有的地图都绘制了。

## map.zig

新增了更新角色走过的地图，绘制时进行判断。

```zig
pub fn updatePlayerWalk() void {
    const viewField = ecs.w.getIdentity(Player, ViewField).?[0];

    for (viewField.y..viewField.y + viewField.h) |y| {
        const start = indexUsize(viewField.x, y);
        @memset(walks[start..][0..viewField.w], true);
    }
}

pub fn draw() void {
    drawPlayerWalk();
    drawPlayerView();
}

fn drawPlayerWalk() void {
    const viewField = ecs.w.getIdentity(Player, ViewField).?[0];

    for (walks, 0..) |isWalk, index| {
        if (!isWalk) continue;
        const pos = TilePosition{
            .x = @intCast(index % WIDTH),
            .y = @intCast(index / WIDTH),
        };
        if (viewField.contains(pos)) continue;

        const tex = getTextureFromTile(tiles[index]);
        camera.drawOption(tex, getPositionFromIndex(index), .{
            .color = .{ .x = 0.5, .y = 0.5, .z = 0.5, .w = 1 },
        });
    }
}
```

## player.zig

新增了更新角色走过的地图。

```zig
fn moveOrAttack(newPos: TilePosition) void {
    ecs.w.addContext(TurnState.monster);
    if (!map.canMove(newPos)) return; // 不能移动，撞墙也算移动

    var view = ecs.w.view(.{ Enemy, TilePosition });
    while (view.next()) |enemy| {
        const position = view.get(enemy, TilePosition);
        if (!newPos.equals(position)) continue;

        const enemyEntity = ecs.w.toEntity(enemy).?;
        ecs.w.add(entity, WantToAttack{enemyEntity});
        return;
    }

    ecs.w.add(entity, newPos);
    ecs.w.add(entity, ViewField{.fromCenter(newPos, viewSize)});
    ecs.w.add(entity, map.worldPosition(newPos));
    map.updatePlayerWalk();
    map.updateDistance(newPos);
    cameraFollow(map.worldPosition(newPos));
}
```

## 效果

![地图历史记忆][1]

[1]: images/地宫探险20.gif

## 附录
