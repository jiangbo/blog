# 0735-sokol-不同平台 Shader

## 目标

sokol 有不同的后端图形 API，但是使用的不同的着色器语言，它提供了一个工具来生成不同的语言。

## 环境

- Time 2025-01-26
- Zig 0.14.0-dev.2851+b074fb7dd

## 参考

1. <https://github.com/floooh/sokol-zig/tree/master/src/examples>
2. <https://github.com/floooh/sokol-tools/tree/master>

## 想法

好像默认是 glsl 语言的，然后生成其它平台的着色器语言。

## test.glsl

顶点着色器和片段着色器写在一起的。

```glsl
@vs vs
in vec4 position;

void main() {
    gl_Position = position;
}
@end

@fs fs
out vec4 frag_color;

void main() {
    frag_color = vec4(1.0, 0.0, 0.0, 1.0);
}
@end

@program test vs fs
```

## sokol-shdc

windows 在 <https://github.com/floooh/sokol-tools-bin/tree/master/bin/win32> 下载。
放到环境变量下，就可以使用 `sokol-shdc` 命令了。

## 着色器转换

使用 AI 编写了一个 powershell 脚本，来对转换不同的着色器语言。

```ps1
$inputFile = $args[0]
$outputFile = [System.IO.Path]::ChangeExtension($inputFile, ".glsl.zig")
$languages = "glsl410:metal_macos:hlsl5:glsl300es:wgsl"
$format = "sokol_zig"
$reflection = "--reflection"
$command = "sokol-shdc -i $inputFile -o $outputFile -l $languages -f $format $reflection"

Invoke-Expression $command
```

## 效果

转换完成后，得到一个 zig 文件，挺大的，没有全部粘贴过来。

```zig
const sg = @import("sokol").gfx;
const std = @import("std");
//
//    #version:1# (machine generated, don't edit!)
//
//    Generated by sokol-shdc (https://github.com/floooh/sokol-tools)
//
//    Cmdline:
//        sokol-shdc -i .\src\shader\test.glsl -o .\src\shader\test.glsl.zig -l glsl410:metal_macos:hlsl5:glsl300es:wgsl -f sokol_zig --reflection
//
//    Overview:
//    =========
//    Shader program: 'test':
//        Get shader desc: shd.testShaderDesc(sg.queryBackend());
//        Vertex Shader: vs
//        Fragment Shader: fs
//        Attributes:
//            ATTR_test_position => 0
//    Bindings:
//
pub const ATTR_test_position = 0;
//
//    #version 410
//
//    layout(location = 0) in vec4 position;
//
//    void main()
//    {
//        gl_Position = position;
//    }
//
//
...
pub fn testImageSlot(img_name: []const u8) ?usize {
    _ = img_name;
    return null;
}
pub fn testSamplerSlot(smp_name: []const u8) ?usize {
    _ = smp_name;
    return null;
}
pub fn testUniformblockSlot(ub_name: []const u8) ?usize {
    _ = ub_name;
    return null;
}
pub fn testUniformblockSize(ub_name: []const u8) ?usize {
    _ = ub_name;
    return null;
}
pub fn testUniformOffset(ub_name: []const u8, u_name: []const u8) ?usize {
    _ = ub_name;
    _ = u_name;
    return null;
}
pub fn testUniformDesc(ub_name: []const u8, u_name: []const u8) ?sg.GlslShaderUniform {
    _ = ub_name;
    _ = u_name;
    return null;
}
pub fn testStoragebufferSlot(sbuf_name: []const u8) ?usize {
    _ = sbuf_name;
    return null;
}
```

## 附录
